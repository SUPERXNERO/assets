class ElementComponent{static components=new Map;static instances=new Map;static #uniqueId=0;static observer=null;static define(e,t){this.components.has(e)&&console.warn(`ElementComponent with name "${e}" is being redefined.`),this.components.set(e,t),this._setupObserver()}static use(e,t,s={}){const n=this.components.get(e);if(!n)return console.error(`Component "${e}" is not defined.`),null;const{data:o={},mode:a="append"}=s,c=this.get(e,{data:o});if(null===c)return null;const i=parseInt(c.match(/data-component-id="(\d+)"/)[1]);switch(a){case"replace":t.outerHTML=c;break;case"update":t.innerHTML=c;break;case"append":default:t.insertAdjacentHTML("beforeend",c)}const r=this.instances.get(i);return r&&(r.element=document.querySelector(`[data-component-id="${i}"]`),this._initializeJS(i)),i}static get(e,t={}){const s=this.components.get(e);if(!s)return console.error(`Component "${e}" is not defined.`),null;const{data:n={}}=t,o=++this.#uniqueId,a={...s.initialData,...n},c={id:o,name:e,config:s,interactiveData:a,element:null,jsReady:!1};return this.instances.set(o,c),this._applyCSS(o,e,s.css),`<div data-component-id="${o}" data-component-name="${e}">${this._processTemplate(s.html,c)}</div>`}static run(e,t,s={}){const n=this.instances.get(e);if(!n||!n.config.functions[t])return void console.error(`Function "${t}" or instance "${e}" not found.`);const o={interactiveData:n.interactiveData,runTimeData:s,instance:n};n.config.functions[t].call(n.config.functions,o)}static _processTemplate(e,t){let s=e;const n=t.interactiveData;return s=s.replace(/--{if\s+(.*?)}--([\s\S]*?)--{\/if}--/g,((e,t,s)=>{try{return new Function("object",`return !!(${t})`)(n)?s:""}catch(e){return console.error(`Error evaluating condition "${t}":`,e),""}})),s=s.replace(/--{ElementComponent.get\("([^"]+)"\s*,\s*({.*?})\)}--/g,((e,t,s)=>{try{const o=new Function("object",`return ${s}`)(n);return this.get(t,{data:o})}catch(e){return console.error(`Error parsing nested component data for "${t}":`,e),""}})),s=s.replace(/--{object\.([^}]+)}--/g,((e,t)=>{const s=t.split(".").reduce(((e,t)=>(e||{})[t]),n);return void 0!==s?s:""})),s}static _applyCSS(e,t,s){if(!s||document.querySelector(`style[data-component-style-for="${t}"]`))return;const n=document.createElement("style");n.setAttribute("data-component-style-for",t),n.textContent=s.replace(/&/g,`[data-component-name="${t}"]`),document.head.appendChild(n)}static _setupObserver(){if(this.observer)return;this.observer=new MutationObserver((e=>{for(const t of e)if("childList"===t.type){t.addedNodes.forEach((e=>{1===e.nodeType&&(e.matches("[data-component-id]")&&this._initializeJS(parseInt(e.dataset.componentId)),e.querySelectorAll("[data-component-id]").forEach((e=>this._initializeJS(parseInt(e.dataset.componentId)))))}));t.removedNodes.forEach((e=>{1===e.nodeType&&(e.matches("[data-component-id]")&&this._destroyInstance(parseInt(e.dataset.componentId)),e.querySelectorAll("[data-component-id]").forEach((e=>this._destroyInstance(parseInt(e.dataset.componentId)))))}))}}));this.observer.observe(document.body,{childList:!0,subtree:!0})}static _initializeJS(e){const t=this.instances.get(e);if(!t||t.jsReady)return;const s=document.querySelector(`[data-component-id="${e}"]`);if(!s)return;t.element=s;const n=t.config;if(n.events&&Array.isArray(n.events)&&n.events.forEach((e=>{const o=e.element,a="&"===o?s:s.querySelector(o);a&&a.addEventListener(e.event,(s=>{const o=n.functions[e.function];o&&o.call(n.functions,{interactiveData:t.interactiveData,instance:t,event:s,eventData:e.data||{}})}))})),n.functions&&n.functions.onReady){const e={instance:t,interactiveData:t.interactiveData};n.functions.onReady.call(n.functions,e)}t.jsReady=!0}static _destroyInstance(e){const t=this.instances.get(e);if(t){const s=t.config;s.functions&&s.functions.onDestroy&&s.functions.onDestroy.call(s.functions,{instance:t,interactiveData:t.interactiveData});this.instances.delete(e)}}}